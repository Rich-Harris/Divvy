(function(t){"use strict";var e;(function(){var t,i,n,s,h,o,r,d,c,a="ontouchstart"in document,l="row",v="column",u="left",f="top",m="width",p="height",y="vertical",g="horizontal",w="clientX",z="clientY";e=function(e){var i,n,h=this;if(this.el=e.el,i=document.createDocumentFragment(),e.columns&&e.rows)throw Error("You can't have top level rows and top level columns - one or the other");e.columns?(this.type=l,n=e.columns):e.rows&&(this.type=v,n=e.rows),this.blocks={},this.subs={},this.min=e.min||10,this.root=new t(this,this,i,"divvy-0",{children:n},0,100,this.type,{top:!0,right:!0,bottom:!0,left:!0}),s(this.root.node,"divvy-root"),this.el.appendChild(i),e.shakeOnResize!==!1&&window.addEventListener("resize",function(){h._changedSinceLastResize={},h.shake(),c(h,"resize",h._changedSinceLastResize)}),this._changed={},this._changedSinceLastResize={},this.shake()},e.prototype={shake:function(){return this.bcr=this.el.getBoundingClientRect(),this.bcr.width!==this.width||this.bcr.height!==this.height?(this.width=this.bcr.width,this.height=this.bcr.height,this.pixelSize=this[this.type===v?p:m],this.root.shake(),this):void 0},changed:function(){var t=this._changed;return this._changed={},t},getState:function(){var t={};return o(this.root,t),t},setState:function(t){var e,i={};r(this,this.root,t,i);for(e in i)if(i.hasOwnProperty(e)){c(this,"resize",i);break}return this},save:function(t){var e,i;if(localStorage)return e=t?"divvy_"+t:"divvy",i=JSON.stringify(this.getState()),localStorage.setItem(e,i),this},restore:function(t){var e,i;if(localStorage)return e=t?"divvy_"+t:"divvy",i=JSON.parse(localStorage.getItem(e)),i&&this.setState(i),this},on:function(t,e){var i,n=this;return(i=this.subs[t])?i[i.length]=e:this.subs[t]=[e],{cancel:function(){n.off(t,e)}}},off:function(t,e){var i,n;return t?e?(n=this.subs[t])?(i=n.indexOf(e),-1!==i&&(n.splice(i,1),n.length||delete this.subs[t]),this):this:(delete this.subs[t],this):(this.subs={},this)}},c=function(t,e){var i,n,s,h;if(n=t.subs[e]){if(i=Array.prototype.slice.call(arguments,2),i.length){for(s=0,h=n.length;h>s;s+=1)n[s].apply(t,i);return t}for(s=0,h=n.length;h>s;s+=1)n[s].call(t)}},o=function(t,e){var i;if(e[t.id]=[t.start,t.size],t.children)for(i=t.children.length;i--;)o(t.children[i],e)},r=function(t,e,i,n){var s,h,o,d,c;if(c=i[e.id]){if((e.start!==c[0]||e.size!==c[1])&&(t._changed[e.id]=n[e.id]=!0),e.start=c[0],e.size=c[1],e.end=e.start+e.size,e.node.style[e.type===v?u:f]=e.start+"%",e.node.style[e.type===v?m:p]=e.size+"%",e.children){for(d=0,h=e.children.length,s=0;h>s;s+=1)o=e.children[s],r(t,o,i,n,!0),d+=o.size,e.controls[s]&&e.controls[s].setPosition(d);for(s=e.children.length;s--;)r(t,e.children[s],i,n,!0)}e.shake()}},d=function(t,e){return e?(t._cursor=t.el.style.cursor,t.el.style.cursor=e+"-resize",void 0):(t.el.style.cursor=t._cursor,void 0)},t=function(e,n,h,o,r,d,c,a,w){var z,b,S,E,L,P,x,_,k;if(this.start=d,this.size=c,this.end=this.start+this.size,this.type=a,this.divvy=e,this.parent=n,this.edges=w,this.min=r.min||e.min,this.max=r.max,r instanceof Element&&(r={node:r}),"string"==typeof r&&(r={id:r}),"[object Array]"===Object.prototype.toString.call(r)&&(r={children:r}),this.id=r.id||o,r.children&&r.children.length?(this.node=document.createElement("div"),s(this.node,"divvy-block"),s(this.node,"divvy-branch"),this.node.id=this.id):(this.node=document.createElement("div"),s(this.node,"divvy-block"),s(this.node,"divvy-leaf"),!r.node&&r.id&&(P=document.getElementById(r.id))&&(r.node=P),this.inner=r.node?r.node:document.createElement("div"),s(this.inner,"divvy-inner"),this.node.appendChild(this.inner),e.blocks[this.id]=this.inner,this.inner.id=this.id),w.top&&s(this.node,"divvy-top"),w.right&&s(this.node,"divvy-right"),w.bottom&&s(this.node,"divvy-bottom"),w.left&&s(this.node,"divvy-left"),this.node.style[a===v?u:f]=d+"%",this.node.style[a===v?m:p]=c+"%",r.children){for(z=r.children.reduce(function(t,e){return t+(e.size||1)},0),this.children=[],this.controls=[],S=0,b=0;r.children.length>b;b+=1)E=r.children[b],L=100*((E.size||1)/z),k={},a===v?(k.top=w.top&&0===b,k.bottom=w.bottom&&b===r.children.length-1,k.left=w.left,k.right=w.right):(k.left=w.left&&0===b,k.right=w.right&&b===r.children.length-1,k.top=w.top,k.bottom=w.bottom),this.children[b]=new t(e,this,this.node,o+b,E,S,L,a===v?l:v,k),S+=L;for(b=0;r.children.length-1>b;b+=1)x=this.children[b],_=this.children[b+1],this.controls[b]=new i(e,this,this.node,x,_,a===l?y:g)}h.appendChild(this.node)},t.prototype={setStart:function(t){var e,i,n,s;e=this.start,i=this.size,n=t-e,s=i-n,this.node.style[this.type===v?u:f]=t+"%",this.node.style[this.type===v?m:p]=s+"%",this.start=t,this.size=s,this.shake()},setEnd:function(t){var e,i,n,s;e=this.end,i=this.size,n=t-e,s=i+n,this.node.style[this.type===v?m:p]=s+"%",this.end=t,this.size=s,this.shake()},shake:function(){var t,e,i,n,s,h;if(this.bcr=this.node.getBoundingClientRect(),(this.bcr.width!==this.width||this.bcr.height!==this.height)&&(this.width=this.bcr.width,this.height=this.bcr.height,this.divvy._changed[this.id]=this.divvy._changedSinceLastResize[this.id]=!0,this.children)){for(this.pixelSize=this.bcr[this.type===v?p:m],e=this.children.length,t=0;e-1>t;t+=1)i=this.children[t],n=this.children[t+1],s=this.controls[t],h=i.minPc(),h>i.size&&(i.setEnd(i.start+h),n.setStart(i.start+h),s.setPosition(i.start+h)),h=i.maxPc(),i.size>h&&(i.setEnd(i.start+h),n.setStart(i.start+h),s.setPosition(i.start+h));for(t=e-1;t>0;t-=1)i=this.children[t-1],n=this.children[t],s=this.controls[t-1],h=n.minPc(),h>n.size&&(i.setEnd(n.end-h),n.setStart(n.end-h),s.setPosition(n.end-h)),h=n.maxPc(),n.size>h&&(i.setEnd(n.end-h),n.setStart(n.end-h),s.setPosition(n.end-h));for(t=this.children.length;t--;)this.children[t].shake()}},minPc:function(){var t;return t=this.parent.pixelSize,100*(this.min/t)},maxPc:function(){var t;return this.max?(t=this.parent.pixelSize,100*(this.max/t)):100}},i=function(t,e,i,n,h,o){var r=this;this.divvy=t,this.parent=e,this.before=n,this.after=h,this.type=o,this.parentNode=i,this.node=document.createElement("div"),s(this.node,"divvy-"+o+"-control"),a&&s(this.node,"divvy-touch-control"),this.setPosition(h.start),this.node.addEventListener("mousedown",function(t){var e,i,s,d,a;t.preventDefault(),e=Math.max(n.start+n.minPc(),h.end-h.maxPc()),i=Math.min(n.start+n.maxPc(),h.end-h.minPc()),s=function(t){var s;s=r.getPosition(t[o===y?w:z]),s=Math.max(e,Math.min(i,s)),n.setEnd(s),h.setStart(s),r.setPosition(s),c(r.divvy,"resize",r.divvy._changedSinceLastResize),r.divvy._changedSinceLastResize={}},d=function(){r.setInactive(),a()},a=function(){window.removeEventListener("mousemove",s),window.removeEventListener("mouseup",d)},window.addEventListener("mousemove",s),window.addEventListener("mouseup",d)}),a&&this.node.addEventListener("touchstart",function(t){var e,i,s,d,a,l,v;1===t.touches.length&&(t.preventDefault(),e=t.touches[0],i=e.identifier,r.setActive(),s=Math.max(n.start+n.minPc(),h.end-h.maxPc()),d=Math.min(n.start+n.maxPc(),h.end-h.minPc()),a=function(t){var e,a;(1!==t.touches.length||t.touches[0].identifier!==i)&&v(),a=t.touches[0],e=r.getPosition(a[o===y?w:z]),e=Math.max(s,Math.min(d,e)),n.setEnd(e),h.setStart(e),r.setPosition(e),c(r.divvy,"resize",r.divvy._changedSinceLastResize),r.divvy._changedSinceLastResize={}},l=function(){r.setInactive(),v()},v=function(){window.removeEventListener("touchmove",a),window.removeEventListener("touchend",l),window.removeEventListener("touchcancel",l)},window.addEventListener("touchmove",a),window.addEventListener("touchend",l),window.addEventListener("touchcancel",l))}),i.appendChild(this.node)},i.prototype={setActive:function(){s(this.node,"divvy-active"),d(this.divvy,this.type===y?"ew":"ns")},setInactive:function(){h(this.node,"divvy-active"),d(this.divvy,!1)},getPosition:function(t){var e,i,n,s;return e=this.parent.bcr,i=e[this.type===y?u:f],n=e[this.type===y?m:p],s=100*(t-i)/n},setPosition:function(t){this.node.style[this.type===y?u:f]=t+"%",this.pos=t}},n=function(t,e){var i,n;for(i=0,n=e.length;n>i;i+=1)if(e[i]===t)return t;return-1},s=function(t,e){var i;t.classList&&t.classList.add?s=function(t,e){t.classList.add(e)}:(i=function(t){return t.replace(/^\s*/,"").replace(/\s*$/,"")},s=function(t,e){var s,h,o;for(s=(t.getAttribute("class")||"").split(" "),o=s.length;o--;)s[o]=i(s[o]);h=s.indexOf?s.indexOf(e):n(e,s),-1===h&&(t.className=s.concat(e).join(" "))}),s(t,e)},h=function(t,e){var i;t.classList&&t.classList.remove?h=function(t,e){t.classList.remove(e)}:(i=function(t){return t.replace(/^\s*/,"").replace(/\s*$/)},h=function(t,e){var s,h;s=t.className.split(" ").map(i),h=s.indexOf?s.indexOf(e):n(e,s),-1!==h&&(s.splice(h,1),t.className=s.join(" "))}),h(t,e)}})(),"undefined"!=typeof module&&module.exports?module.exports=e:"undefined"!=typeof define&&define.amd?define(function(){return e}):t.Divvy=e})(this);